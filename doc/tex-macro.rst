.. _latex_to_img:

Built-in LaTeX to image macro
-----------------------------

.. currentmodule:: course.latex

Relate provides a built-in
`Jinja <http://jinja.pocoo.org/docs/dev/templates/>`_ macro named
``latex`` which automatically converts the wrapped LaTex code into a cached
image, which is consequently rendered in a html page.
For example:

.. code-block:: jinja

    <p align="middle">
    {% call latex(compiler="pdflatex", image_format="png", alt="example") %}
.. code-block:: latex

        \documentclass{article}
        \usepackage[utf8]{inputenc}
        \usepackage[table]{xcolor}
        \setlength{\arrayrulewidth}{1mm}
        \setlength{\tabcolsep}{18pt}
        \renewcommand{\arraystretch}{2.5}
        \newcolumntype{s}{>{\columncolor[HTML]{AAACED} } p{3cm} }
        \arrayrulecolor[HTML]{DB5800}
        \begin{document}
        \begin{tabular}{ |s|p{3cm}|p{3cm}|  }
        \hline
        \rowcolor{lightgray} \multicolumn{3}{|c|}{Country List} \\
        \hline
        Country Name    or Area Name& ISO ALPHA 2 Code &ISO ALPHA 3 \\
        \hline
        Afghanistan & AF &AFG \\
        \rowcolor{gray}
        Aland Islands & AX & ALA \\
        Albania   &AL & ALB \\
        Algeria  &DZ & DZA \\
        American Samoa & AS & ASM \\
        Andorra & AD & \cellcolor[HTML]{AA0044} AND    \\
        Angola & AO & AGO \\
        \hline
        \end{tabular}

        \end{document}

.. code-block:: jinja

    {% endcall %}
    </p>

The above markup creates a horizontally centered image of a colored
LaTex table::

    <p align="middle">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfMAAAGHC..."
        alt="example" class="img-responsive">
    </p>

Prerequisites
^^^^^^^^^^^^^
* **TexLive**
    - For installation of TexLive.
      See `Instructions on TUG <https://www.tug.org/texlive/doc/texlive-en/texlive-en.html#installation>`_.
    - For Linux platform
        - Vanilla TexLive is preferable if you want to use latest version
          of TexLive and not to bother upgrading packages.
        - If you don't mind use outdated version of TexLive, you can also
          install the version comes with Linux distributed by::

            sudo apt-get install texlive-full

* **latexmk**, required, shipped with TexLive full installation,
  version >= 4.39 is required.
* **dvisvgm**, optional, shipped with TexLive full installation.
* **dvipng**, required, shipped with TexLive full installation.
* **ImageMagick**, required.
    - For Windows platform, install with option
      ``install legacy component`` ticked.
* **MongoDB**, required.

Configurations
^^^^^^^^^^^^^^
In your :file:`local_settings.py`:

* Enable latex to image functionality by configuring
  "RELATE_LATEX_TO_IMAGE_ENABLED = True".
* Configure "RELATE_LATEX_BIN_PATH" option to
  the bin path of the TexLive installation. For example,
  "/usr/local/texlive/2015/bin/x86_64-linux". That is also
  where ``latexmk``, ``dvisvgm`` and ``dvipng`` should be
  found.
* Configure ImageMagick bin path "RELATE_IMAGEMAGICK_BIN_DIR" to
  the absolute path of the location of the bin ``convert``
  (``convert.exe`` for Windows) of your ImageMagick installation.
  This is required for Windows since Windows itself has another
  cmd named ``convert``.
* Configure "IMAGE_CACHE_MAX_BYTES" option to set the max cache
  bytes for generated images. Note that the value should be
  larger than most images converted, or else those images won't be
  cached and will resulting in more disk reading.

Usage
^^^^^

Generally, it can be done by simply wrapping the source code
of a full latex document by the ``latex`` caller:

.. code-block:: jinja

    {% call latex(compiler="pdflatex", image_format="png") %}
        The latex source code
    {% endcall %}

By *full document* we mean it must contain ``\documentclass``,
``\begin{document}`` and ``end{document}``.

* Required params:
    **compiler**
        str, the command line used to compile the tex
        file, currently available: ``xelatex``, ``pdflatex``, ``latex``
        and ``lualatex``.
    **image_format**
        str, the output format of the image, only
        ``png`` and ``svg`` are available.

    .. note::
        * Output with ``svg`` format only support ``latex`` as compiler.
          If ``compiler="latex"``.
        * If the code contains figure generated by ``tikz/pgf`` , the
          image_format will be forced using ``svg``.
        * ``svg`` images generated are always huge in size, sometimes 10
          times of that of the png images. It consume more caches and slow
          down the rendering of pages on browsers.

* Optional params:
    **tex_filename**
        A string, the based filename of the latex, and image
        as well, if not set, use md5 of the full latex code.
    **tex_preamble**
        A string, which allows user move the preamble part of
        the latex code out of the ``latex`` macro. For example, we can use
        ``{% set foo %}{% endset %}`` block to define ``foo`` as the preamble
        and then use ``tex_premable=foo`` as an argument of the ``latex``
        caller. Those definitions can also be saved as macros in the course
        repo. That is a good practice for latex code with common preambles.
        However, this should be used with cautiousness, as changing of the
        preamble definition will force all the originally valid images,
        whose preambles have been changed, to be recompiled, which might
        result in failure (same for ``tex_preamble_extra``). For latex code
        that might be changed in the future, the best practice is to keep
        full latex document in the page markup.
    **tex_preamble_extra**
        A string, more packages or settings appended to
        ``tex_preamble``.

    Using ``tex_preamble``, the above example can be changed to the following
    which generate exactly the same output.

    .. code-block:: jinja

        {% set preamble %}
            \documentclass{article}
            \usepackage[utf8]{inputenc}
            \usepackage[table]{xcolor}
            \setlength{\arrayrulewidth}{1mm}
            \setlength{\tabcolsep}{18pt}
            \renewcommand{\arraystretch}{2.5}
            \newcolumntype{s}{>{\columncolor[HTML]{AAACED} } p{3cm} }
            \arrayrulecolor[HTML]{DB5800}
        {% endset %}

        <p align="middle">
        {% call latex(compiler="pdflatex", image_format="png",
         tex_preamble=preamble, alt="example") %}
    .. code-block:: latex

            \begin{document}
            \begin{tabular}{ |s|p{3cm}|p{3cm}|  }
            \hline
            \rowcolor{lightgray} \multicolumn{3}{|c|}{Country List} \\
            \hline
            Country Name    or Area Name& ISO ALPHA 2 Code &ISO ALPHA 3 \\
            \hline
            Afghanistan & AF &AFG \\
            \rowcolor{gray}
            Aland Islands & AX & ALA \\
            Albania   &AL & ALB \\
            Algeria  &DZ & DZA \\
            American Samoa & AS & ASM \\
            Andorra & AD & \cellcolor[HTML]{AA0044} AND    \\
            Angola & AO & AGO \\
            \hline
            \end{tabular}
            \end{document}
    .. code-block:: jinja

        {% endcall %}
        </p>

    **force_regenerate**
        A boolean, if True, regenerate the image no matter
        it exists or not. Default to ``False``.
    **html_class_extra**
        A string, extra html class for the ``<img>`` tag,
        besides ``img-responsive``.
    **alt**
        A string, a brief description of the image, Default to the
        document part of the tex source.
    **empty_pagestyle**
        A boolean, if ``True``, ``\pagestyle{empty}`` will
        be added to existing preamble and a standalone image will be
        generated. Default to ``True``.

.. note::

    ``{{``, ``}}``, ``{%``, ``%}``, ``{#`` and ``#}`` are used as marking
    strings in jinja template, latex code submitted (including preabmle
    part and self-defined commands) should avoid containing those strings,
    or else jinja will just fail to render. The work around is to manually
    insert a space (spaces or tabs) between the two character (e.g.,
    ``{{`` --> ``{  {``) for each of those strings appeared in latex code.

A more sophisticated example can be found at
`relate-example <https://github.com/inducer/relate-sample/pull/4>`_.