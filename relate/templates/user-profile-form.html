{% extends "base.html" %}
{% load i18n %}

{% load crispy_forms_tags %}

{% block content %}
  <div id="profile-form-info"> </div>
  <h1>{% trans "User Profile" %}</h1>
  <div class="well">
    {% crispy user_form %}
  </div>
  <div class="well">
    <a href="{% url 'relate-logout' %}" class="btn btn-default col-lg-offset-2">{% trans "Sign out" %}</a>
  </div>


<script type="text/javascript">

    // parse url: http://stackoverflow.com/a/12254019/3437454
    function getParam(name) {
        var half = location.search.split('&' + name + '=')[1];
        if (!half) half = location.search.split('?' + name + '=')[1];
        return half !== undefined ? decodeURIComponent(half.split('&')[0]) : null;
    }

    function hasParam(name) {
        return getParam(name) !== null ? true : false;
    }

    function disable_widget_no_id(){
        $('#div_id_confirm_institutional_id').hide();
        $('#id_institutional_id').prop('disabled', true);
        $("#id_no_institutional_id").prop('checked', true);
    }

    function enable_widget_no_id(){
        $('#div_id_confirm_institutional_id').show();
        $('#id_institutional_id').prop('disabled', false);
    }

    
    var first_login = hasParam("first_login");
    var set_inst_id = hasParam("set_inst_id");
    
    if(!(first_login||set_inst_id)){disable_widget_no_id();}
    else{
        if ($("#id_institutional_id").val().length > 0){
            $('#id_institutional_id').prop('disabled', true);
        }
    };


    $(document).on('click', '#id_no_institutional_id', function(event) {
        if (this.checked) {
            disable_widget_no_id();
            $('#id_institutional_id').val("");
            $('#id_confirm_institutional_id').val("")}
        else {enable_widget_no_id();}
    });

    // ajax form submit

    var profile_form = '#profile-form';
    
    $(document).on('submit', profile_form, function(event){
        event.preventDefault();
        sumbit_ajax();
    });

    function sumbit_ajax() {
        $.ajax({
            url : "{% url 'relate-profile_form_ajax' %}",
            type : "POST", // http method
            data : $(profile_form).serialize(), 
            success: function(data) {
                if (!(data['success'])) {
                    $(profile_form).replaceWith(data['form_html']);
                }
                else {
                    $('#div_id_confirm_institutional_id').hide();
                    $('#id_institutional_id').prop('disabled', true);
                    if ($("#id_institutional_id").val().length > 0){
                        $('#div_id_no_institutional_id').hide();}
                    else{
                        $("#id_no_institutional_id").prop('checked', true);
                    };
                    if (data['success_messages']) {
                        $("#profile-form-info")
                            .addClass("alert alert-info")
                            .html('<i class="fa fa-info-circle"></i> '
                                  + data['success_messages']);
                        window.setTimeout(
                            function() {
                                $("#profile-form-info")
                                    .fadeOut()
                                    .removeClass("alert alert-info")
                                    .html("")
                                    .fadeIn();
                                if (first_login){
                                    window.location.replace('{% url "relate-home" %}');}
                                if (hasParam("referer")){
                                    window.location.replace(getParam("referer"));}
                            },
                            3000);
                    };
                };
            },
        });
    }

</script>
{% endblock %}
