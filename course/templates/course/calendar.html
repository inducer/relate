{% extends "course/course-base.html" %}
{% load i18n %}

{% load static %}

{% block title %}
  {{ course.number }}
  {% trans "Calendar" %} - {{ relate_site_name }}
{% endblock %}

{% block head_assets_extra %}
  <link rel='stylesheet' href='{% static "fullcalendar/dist/fullcalendar.css" %}?version=3.9.0'/>
  <script src='{% static "moment/moment.js" %}'></script>
  <script src='{% static "fullcalendar/dist/fullcalendar.min.js" %}?version=3.9.0'></script>
  {# load calendar with local language #}
  {% get_current_language as LANGUAGE_CODE %}
  {% if LANGUAGE_CODE != "en" %}
    <script src='{% static "fullcalendar/dist/locale/" %}{{ LANGUAGE_CODE |js_lang_fallback:"fullcalendar" }}.js?version=3.9.0'></script>
  {% endif %}
  {% if pperm.edit_events %}
    <script src='{% static "blueimp-tmpl/js/tmpl.min.js" %}'></script>
  {% endif %}

  {% if pperm.edit_events %}
    <style>
      .spinner {
        background: rgba(0, 0, 0, .2) url({% static "images/busy.gif" %}) no-repeat center center;
        width: 100%;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 999;
      }
    </style>
  {% endif %}

{% endblock %}


{% block content %}
  <h1>{{ course.number }} {% trans "Calendar" %}</h1>
  <div id="course-cal" style="margin-top:3em"></div>
  {% if pperm.edit_events %}
    <div id="cover"></div>
  {% endif %}
  <b class="relate-calendar-notes">{% trans "Note" %}:</b>
  {% trans "Some calendar entries are clickable and link to entries below." %}

  <div id="relate-event-info" style="margin-top:3ex">{{ events_info_html|safe }}</div>
{% endblock %}

{% block page_bottom_javascript_extra %}
  <script type="text/javascript">
    (function(){
      var $courseCal = $('#course-cal'),
        $relateEventInfo = $('#relate-event-info');

      $(document).ready(function () {
        $courseCal.fullCalendar({
          header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay,listMonth'
          },
          contentHeight: "auto",
          defaultDate: '{{ default_date }}',
          defaultView: $(window).width() < 765 ? 'listMonth': 'month',
          timezone: "local",
          nowIndicator: true,
          views: {
            month: {
              displayEventEnd: $(window).width() < 765 ? false: true
            }
          },
          minTime: "06:00:00",
          maxTime: "24:00:00",
          loading: function(isLoading, view){
            if (isLoading)
              $("#cover").addClass('spinner');
            else $("#cover").removeClass('spinner');
          },
        {% if not pperm.edit_events %}
          events: {{ events_json|safe }},
        {% else %}
          events: function (start, end, timezone, callback) {
            var fetchUrl = '{% url "relate-fetch_events" course.identifier %}';
            $.ajax({
              url: fetchUrl,
              success: function (result) {
                $relateEventInfo.empty().html(result.events_info_html);

                {# use events_json as eventSource #}
                callback(result.events_json);
                }
              })
            },
        {% endif %}
        });
      });
    })();

  </script>

  {{ block.super }}
{% endblock %}

