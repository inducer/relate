{% extends "course/course-base.html" %}
{% load i18n %}

{% load static %}

{% block title %}
  {{ course.number}}
  {% trans "Calendar" %} - {% trans "RELATE" %}
{% endblock %}

{% block header_extra %}
  <link rel='stylesheet' href='{% static "fullcalendar/dist/fullcalendar.css" %}' />
  <script src='{% static "moment/moment.js" %}'></script>
  <script src='{% static "fullcalendar/dist/fullcalendar.js" %}'></script>
  {# load calendar with local language #}
  {% get_current_language as LANGUAGE_CODE %}
  <script src='{% static "fullcalendar/dist/lang/" %}{{ LANGUAGE_CODE }}.js'></script>
{% endblock %}

{% block content %}
  <h1>{{ course.number}} {% trans "Calendar" %}</h1>
  {% if pperm.edit_events %}
    <div>
      <a
          {% if edit_view %}
            href="{% url "relate-view_calendar" course.identifier %}"
          {% else %}
            href="{% url "relate-edit_calendar" course.identifier %}"
          {% endif %}
          type="button" class="btn btn-primary">
        {% if edit_view %}
          {% trans "Switch to Student View" %}
        {% else %}
          {% trans "Switch to Edit View" %}
        {% endif %}
      </a>
      {% if edit_view %}
        <button id="create-new-event" type="button" class="btn btn-danger btn-md" data-toggle="modal" data-target="#editModal" onclick="remove_event_id_field();" title="create a new event">{% trans "Create a new event" %}</button>
      {% endif %}
    </div>
  {% endif %}
  <div id="coursecal" style="margin-top:3em"></div>

  <b>{% trans "Note" %}:</b> {% if edit_view %}{% trans "Different from the students' calendar, this calender shows <b>all</b> events. " %}{% endif %}{% trans "Some calendar entries are clickable and link to entries below." %}


  <div style="margin-top:3ex">
  {% for event_info in event_info_list %}
    <div id="event-{{ event_info.id }}" class="panel panel-default relate-calendar-event">
      <div class="panel-heading">
        <b>{{ event_info.human_title }}</b>
        ({{ event_info.start_time }}{% if event_info.end_time %} - {{ event_info.end_time }}{% endif %})
      </div>
      <div class="panel-body">
        {{ event_info.description|safe }}
      </div>
    </div>
  {% endfor%}
  </div>

  {% if edit_view %}
    <div id="editModal" class="modal fade" role="dialog">
      <div class="modal-dialog"  style="width:800px">
        <form method="POST" class="form-horizontal">
          <div class="modal-content">
            <div class="modal-body">
              <br>
              {% load crispy_forms_tags %}
              {% if form_description %}
                <h1>{{ form_description }}</h1>
              {% endif %}
              {{ form_text|safe }}
              {% if form %}
                {% crispy form %}
              {% endif %}
              {% if forms %}
                {% for sub_form in forms %}
                  <div class="well">
                    {% crispy sub_form %}
                  </div>
                {% endfor %}
              {% endif %}
              {% if edit_existing_event_flag %}
                <input type="hidden" name="existing_event_to_save" id="existing_event_to_save" value='{{id_to_edit}}' readonly>
              {% endif %}
            </div>
            <div class="modal-footer">
              <button class="btn btn-md btn-default" data-dismiss="modal" type="button">{% trans "Cancel" %}</button>
              <button class="btn btn-md btn-success" type="submit">{% trans "Save" %}</button>
            </div>
        </form>
      </div>
    </div>
    <form method='post' name='existing_event_edit_form'>
      {% csrf_token %}
      <input type='Hidden' name='id_to_edit' id="id_to_edit" value=''>
    </form>
    <form method='post' name='existing_event_delete_form'>
      {% csrf_token %}
      <input type='Hidden' name='id_to_delete' id="id_to_delete" value=''>
    </form>
  {% endif %}
{% endblock %}

{% block page_bottom_javascript_extra %}
  <script type="text/javascript">
    $(document).ready(function() {
      $('#coursecal').fullCalendar({
        header: {
          left: 'prev,next today',
          center: 'title',
          right: 'month,agendaWeek,agendaDay'
        },
        defaultDate: '{{ default_date }}',
        timezone: "local",
        events: {{ events_json|safe }},
        {% if edit_view %}
          eventRender: function(event, element) {
            element.find('.fc-title').append( '<span class="glyphicon glyphicon-remove-circle" style="float:right;cursor:pointer" id="remove" title="{% trans 'Remove this event'%}" data-confirm="{% trans "Are you sure you want to delete this event?" %}" data-event-id="'+event.id+'"></span>');
            element.find('.fc-title').append( '<span class="glyphicon glyphicon-pencil" style="float:right; cursor:pointer" id="edit" title="{% trans 'Edit this event'%}"> </span>');
            element.find("#edit").click(function() {
              edit_existing_event(event.id);
            });
            element.find("span[data-confirm]").click(function() {
              var event_id = $(this).data('event-id');
              if (!$('#deleteConfirmModal').length) {
                $('body').append(
                    '<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">' +
                    '  <div class="modal-dialog" role="document">' +
                    '    <div class="modal-content">' +
                    '      <div class="modal-header">' +
                    '        <button type="button" class="close" data-dismiss="modal" aria-label="Close">' +
                    '          <span aria-hidden="true">&times;</span>' +
                    '        </button>' +
                    '        <h3 class="modal-title" >{% trans "Please confirm" %}</h3>' +
                    '      </div>' +
                    '      <div class="modal-body">' +
                    '      </div>' +
                    '      <div class="modal-footer">' +
                    '        <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Cancel" %}</button>' +
                    '        <button type="button" class="btn btn-primary" id="deleteConfirmOK">{% trans "Delete" %}</button>' +
                    '      </div>' +
                    '    </div>' +
                    '  </div>' +
                    '</div>');
              }
              var $delete_confirm_modal = $('#deleteConfirmModal');
                  $delete_confirm_modal.find('.modal-body').text($(this).attr('data-confirm'));
                  $('#deleteConfirmOK').data('event-id', event_id).click(function() {
                delete_existing_event($(this).data('event-id'));
              });
                  $delete_confirm_modal.modal({show:true});
                  return false;
              });
          }
        {% endif %}
      });
      {% if edit_view %}
        {% if edit_existing_event_flag %}
          $('#editModal').modal('show');
        {% endif %}
      {% endif %}
    });

    $(function () {
      $('#start_time').datetimepicker({"format": "YYYY-MM-DD HH:mm", "sideBySide": true});
      $('#end_time').datetimepicker({"format": "YYYY-MM-DD HH:mm", "sideBySide": true});
    });

    function edit_existing_event(event_id) {
      $('#id_to_edit').val(event_id);
      document.existing_event_edit_form.submit();
    }

    function delete_existing_event(event_id) {
      $('#id_to_delete').val(event_id);
      document.existing_event_delete_form.submit();
    }

    function remove_event_id_field() {
      $('#existing_event_to_save').remove()
    }

  </script>
  {{ block.super }}
{% endblock %}