{% extends "course/course-base.html" %}
{% load i18n %}

{% load crispy_forms_tags %}
{% load static %}

{% block title %}
  [{{ page_data.next_ordinal }}/{{ flow_session.page_count }}]
  {{title}} - {{ flow_desc.title}} - {% trans "RELATE" %}
{% endblock %}

{% block content %}
  {# {{{ navigation #}
  <form
    action="{% url "relate-view_flow_page" course.identifier flow_session.id page_data.ordinal %}"
    class="navigation-form"
    method="POST">

    {% csrf_token %}

    <div class="well flow-well">
      {# {{{ prev/next buttons #}

      <div class="flow-nav">
        {% if page_data.ordinal > 0 %}
          <a class="btn btn-default relate-nav-button"
            href="{% url "relate-view_flow_page" course.identifier flow_session.id page_data.previous_ordinal %}"
            title='{% trans "Previous page" context "Previous page/item in a flow" %}'
            role="button"><i class="fa fa-chevron-left"></i></a>
        {% else %}
          <a class="btn btn-default relate-nav-button disabled"
            href="#"
            title='{% trans "Previous page" context "Previous page/item in a flow" %}'
            role="button"><i class="fa fa-chevron-left"></i></a>
        {% endif %}
        {% if page_data.next_ordinal < flow_session.page_count %}
          <a class="btn btn-default relate-nav-button"
            href="{% url "relate-view_flow_page" course.identifier flow_session.id page_data.next_ordinal %}"
            title='{% trans "Next page" context "Next page/item in a flow" %}'
            role="button"><i class="fa fa-chevron-right"></i></a>
        {% else %}
          <a class="btn btn-default relate-nav-button disabled"
            href="#"
            title='{% trans "Next page" context "Next page/item in a flow" %}'
            role="button"><i class="fa fa-chevron-right"></i></a>
        {% endif %}
        <button id="btn_bookmark"
                class="btn btn-default relate-flow-page-bookmark-button
                {% if page_data.bookmarked %}
                relate-bookmarked
                {% endif %}
                "
                title="{% trans "Boomark this page" %}">
          <i id="label_bookmark_indicator" class="fa
            {% if page_data.bookmarked %}
              fa-star
            {% else %}
              fa-star-o
            {% endif %}
            " aria-hidden="true"></i>
        </button>
      </div>

      {# }}} #}

      {# {{{ send email button #}
      {% if may_send_email_about_flow_page %}
        <div class="navbar-right relate-flow-page-send-email"
             style="padding-right: 0.4em;">
            <a href="{% url 'relate-flow_page_interaction_email' course.identifier flow_session.id ordinal %}"
               class="btn btn-default relate-nav-button btn-info"
               title="{% trans 'Send an email about this page to course staff' %}"
               target="_blank"
            >
                <i class="fa fa-envelope-o" aria-hidden="true"></i>
            </a>
        </div>
      {% endif %}
      {# }}} #}

      {# {{{ menu #}

      <div class="navbar-right relate-flow-page-menu"
        style="padding-right: 0.4em;">
        <div class="dropdown">
          <button class="btn btn-default dropdown-toggle" type="button" id="menu_dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"
            title='{% trans "Page Menu" %}'>
            <i class="fa fa-bars"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="menu_dropdown">
            <li>
              <a href='{% url "relate-view_start_flow" course.identifier flow_session.flow_id %}'
                >{% trans "Return to flow start page" %}</a>
            </li>
            {% if page_expect_answer_and_gradable %}
              {% if pperm.reopen_flow_session and not flow_session.in_progress and opportunity.id != None %}
                <li>
                  <a href="{% url 'relate-view_reopen_session' course.identifier flow_session.id opportunity.id %}"
                     target="_blank">
                    {% trans "Reopen" %} <i class="fa fa-lock" aria-hidden="true"></i>
                  </a>
                </li>
              {% endif %}
              {% if page_expect_answer_and_gradable and pperm.grant_exception and flow_session.participation.id != None %}
                <li>
                  <a href="{% url 'relate-grant_exception_stage_3' course.identifier flow_session.participation.id flow_session.flow_id flow_session.id %}"
                    target="_blank">
                      {% trans "Grant exception" %} <i class="fa fa-lock" aria-hidden="true"></i>
                  </a>
                </li>
              {% endif %}
              {% if pperm.view_gradebook %}
                <li>
                  <a href="{% url 'relate-grade_flow_page' course.identifier flow_session.id ordinal %}"
                     target="_blank">
                      {% trans "View in grading interface" %} <i class="fa fa-lock" aria-hidden="true"></i>
                  </a>
                </li>
              {% endif %}
            {% endif %}
          </ul>
        </div>
      </div>

      {# }}} #}

      {# {{{ past submissions #}

      {% if prev_answer_visits|length > 1 %}
      <div class="navbar-right relate-flow-page-past-submissions"
        style="padding-right: 0.4em; margin-right:0;">
        <div class="dropdown">
          <button class="btn btn-default dropdown-toggle" type="button" id="past-submission_dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"
            title='{% trans "Submission history for this page" %}'>
            <i class="fa fa-history"></i>
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" aria-labelledby="past-submission_dropdown">
            {% for pvisit in prev_answer_visits %}
            <li>
              {% if forloop.first %}
                <a href="?">
              {% else %}
                <a href="?visit_id={{ pvisit.id }}">
              {% endif %}

              {% if prev_visit_id == pvisit.id %}<b>{% endif %}
                {{ pvisit.visit_time }}
              {% if prev_visit_id == pvisit.id %}</b>{% endif %}
              {% if forloop.first %}
                {% trans "(current)" %}
              {% endif %}
              {% if pvisit.is_submitted_answer %}
                {% trans "(submitted)" %}
              {% endif %}
            </a></li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}

      {# }}} #}

      {# {{{ 'finish' button #}

      <div class="navbar-right relate-flow-submit"
        style="padding-right: 0.4em;">
        <button type="submit" name="finish" class="btn btn-default relate-nav-button
        {% if flow_session.in_progress %}
          {% if not interaction_kind == flow_session_interaction_kind.noninteractive %}
            btn-success
          {% endif %}
        {% endif %}"
        title='
        {% if interaction_kind == flow_session_interaction_kind.noninteractive %}
            {% trans "Go to end" %}
        {% elif flow_session.in_progress %}
          {% if interaction_kind == flow_session_interaction_kind.ungraded %}
            {% trans "Submit" %}
          {% elif interaction_kind == flow_session_interaction_kind.permanent_grade %}
            {% trans "Submit assignment" %}
          {% else %}
            {% trans "Finish" %}
          {% endif %}
        {% elif not flow_session.in_progress %}
          {% if interaction_kind == flow_session_interaction_kind.ungraded or interaction_kind == flow_session_interaction_kind.permanent_grade %}
            {% trans "Result" %}
          {% else %}
            {% trans "Finish" %}
          {% endif %}
        {% endif %}
        '>
        {% if interaction_kind == flow_session_interaction_kind.permanent_grade or interaction_kind == flow_session_interaction_kind.ungraded %}
          {% if flow_session.in_progress %}
            <i class="fa fa-check" aria-hidden="true"></i>
          {% else %}
            <i class="fa fa-bar-chart" aria-hidden="true"></i>
          {% endif %}
        {% else %}
            <i class="fa fa-sign-out" aria-hidden="true"></i>
        {% endif %}
        </button>
      </div>

      {# }}} #}

      {# {{{ expiration mode #}

      {% if flow_session.in_progress and expiration_mode_choice_count > 1 %}
        <div class="flow-session-expiration-panel">
          <span id="expiration_mode_change_progress">
          </span>
          <label for="id_expiration_mode">
            {# Translators: the string is followed by "what will happen" at deadline. #}
            {% trans "At deadline:" %}
          </label>
          <select class="select form-control" id="id_expiration_mode"
              name="expiration_mode">
            {% for key, val in expiration_mode_choices %}
              <option value="{{ key }}"
                  {% if key == expiration_mode %}
                    selected
                  {% endif %}
              >{{ val }}</option>
            {% endfor %}
          </select>
        </div>
      {% endif %}

      {# }}} #}

      {# {{{ toc #}

      <div class="relate-flow-page-toc">
        {% for other_page_data in all_page_data %}
          {% if other_page_data.ordinal == page_data.ordinal %}
            <span class="relate-flow-page-toc-item btn btn-default btn-xs disabled
              relate-current
              {% if other_page_data.bookmarked %}
                relate-bookmarked
              {% endif %}
              ">{{ other_page_data.human_readable_ordinal }}</span>
          {% else %}
            <a href="{% url "relate-view_flow_page" course.identifier flow_session.id other_page_data.ordinal %}"
               title="{{ other_page_data.title }}">
            <span class="relate-flow-page-toc-item btn btn-default btn-xs
              {% if page_nr < page_data.ordinal %}
                relate-prior
              {% else %}
                relate-subsequent
              {% endif %}
              {% if other_page_data.bookmarked %}
                relate-bookmarked
              {% endif %}
              {% if other_page_data.ordinal in flow_page_ordinals_with_answers %}
                relate-answered
              {% endif %}
              ">{{ other_page_data.human_readable_ordinal }}
            </span></a>
          {% endif %}
        {% endfor %}

        {% if flow_session.page_count >= 4 %}
          <span class="dropdown">
            <span class="btn btn-default btn-xs dropdown-toggle relate-flow-page-toc-item " id="toc-dropdown" data-toggle="dropdown"
              aria-haspopup="true" aria-expanded="true">
              <span class="caret"></span>
            </span>
            <ul class="dropdown-menu" aria-labelledby="toc-dropdown">
              {% for other_page_data in all_page_data %}
              <li>
                <a href="{% url "relate-view_flow_page" course.identifier flow_session.id other_page_data.ordinal %}">
                  {{ other_page_data.human_readable_ordinal }}: {{ other_page_data.title }}
                  {% if other_page_data.bookmarked %}
                    <i class="fa fa-star" aria-hidden="true"></i>
                  {% endif %}
                </a>
              </li>
              {% endfor %}
            </ul>
          </span>
        {% endif %}
      </div>

      {# }}} #}

      <div style="clear:both; height:0px"></div>

      {# {{{ session time #}

      {% if session_minutes != None %}
        <div class="relate-session-duration">
          {% trans "Session duration:" %}
          {{ session_minutes|floatformat:1 }}
          {% trans "minutes" %}

          {% if time_factor != 1 %}
          ({% trans "Time factor:" %} {{ time_factor|floatformat:2 }}x)
          {% endif %}
        </div>
      {% endif %}

      {# }}} #}
    </div>
  </form>

  {# }}} #}

  {# {{{ points #}

  {% if max_points %}
    <div style="float:right" class="well">
    {% blocktrans trimmed count counter=max_points %}
      {{ max_points }} point
    {% plural %}
      {{ max_points }} points
    {% endblocktrans %}
    </div>
  {% elif is_optional_page %}
    <div style="float:right" class="well">
    {% trans "Optional question" %}
    </div>
  {% endif %}

  {# }}} #}

  {{ body|safe }}

  {# {{{ form #}

  {% if form_html %}
    <div class="well relate-interaction-container">
      {{ form_html|safe }}

      {% if may_change_graded_answer and will_receive_feedback %}
        {% if form.no_offset_labels %}
          <div class="text-muted">
        {% else %}
          <div class="text-muted col-lg-offset-2 ">
        {% endif %}
          {% trans "(You may still change your answer after you submit it.)" %}
        </div>
      {% endif %}
    </div>
  {% endif %}

  {# }}} #}

  {# {{{ feedback #}

  {% if show_correctness and feedback %}
    <div class="alert
      {% if feedback.correctness >= 1 %}
        alert-success
      {% elif feedback.correctness == 0 %}
        alert-danger
      {% else%}
        alert-info
      {% endif %}
      ">
        <p>{{ feedback.feedback|safe }}</p>
        {% if feedback.bulk_feedback %}
          <p>{{ feedback.bulk_feedback|safe }}</p>
        {% endif %}
      {% if show_answer and correct_answer %}
        <p>{{ correct_answer|safe }}</p>
      {% endif %}
    </div>
  {% elif show_answer and correct_answer %}
    {# show only correct answer, without indication of correctness #}
    <div class="well">
      <p>{{ correct_answer|safe }}</p>
    </div>
  {% endif %}

  {# }}} #}

  {# {{{ change listening, navigation confirmation #}

  <script type="text/javascript">

    function activate_change_listening()
    {
      var input_changed = false;

      // {{{ listen for codemirror changes

      function on_cm_change(cm, change_obj)
      {
        input_changed = true;
      }

      $("div.CodeMirror").each(
          function ()
          {
            var cm = this.CodeMirror;
            cm.on("change", on_cm_change);
          });

      // }}}

      // {{{ listen for other input changes

      function on_input_change(evt)
      {
        input_changed = true;
      }

      $(":checkbox").on("change", on_input_change);
      $(":radio").on("change", on_input_change);
      $(":text").on("change", on_input_change);
      $(":file").on("change", on_input_change);
      $("textarea").on("change", on_input_change);

      // }}}

      $(window).on('beforeunload',
          function()
          {
            if (input_changed)
              return "{% trans 'You have unsaved changes on this page.' %}";
          });

      function before_submit(evt)
      {
        input_changed = false;

        // We can't simply set "disabled" on the submitting button here.
        // Otherwise the browser will simply remove that button from the POST
        // data.

        $(".relate-save-button").each(
            function()
            {
              var clone = $(this).clone();
              $(clone).attr("disabled", "1");
              $(this).after(clone);
              $(this).hide();
            });
      }

      $(".relate-interaction-container form").on("submit", before_submit);
    }

    $(document).ready(activate_change_listening);
  </script>

  {# }}} #}

  {# {{{ expiration mode handling #}

  <script type="text/javascript">

    // using jQuery
    function get_cookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function expiration_mode_changed()
    {
      $("#expiration_mode_change_progress")
        .html(
          '<img src="{% static "images/busy.gif" %}" alt="Busy indicator">')
        .show();

      var jqxhr = $.ajax(
          "{% url "relate-update_expiration_mode" course.identifier flow_session.id %}",
          {
            type: "POST",
            data: {
              expiration_mode: $("#id_expiration_mode").val()
            },
            beforeSend: function(xhr, settings) {
              var csrftoken = get_cookie('csrftoken');
              xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
          })
        .done(function() {
          $("#expiration_mode_change_progress")
            .html('{% trans "Saved." %}');
          window.setTimeout(
              function() { $("#expiration_mode_change_progress").fadeOut() },
              3000);
        })
        .fail(function() {
          $("#expiration_mode_change_progress")
            .html('{% trans "Error--not saved." %}');
          window.setTimeout(
              function() { $("#expiration_mode_change_progress").fadeOut() },
              3000);
        });
    }

    $("#id_expiration_mode").on("change", expiration_mode_changed);
  </script>

  {# }}} #}

  {# {{{ bookmark button #}

  <script type="text/javascript">
    function activate_bookmark_button()
    {
      var btn_bookmark = $("#btn_bookmark");
      btn_bookmark.click(
          function(evt)
          {
            evt.preventDefault();

            var ind = $("#label_bookmark_indicator");
            var prev_bookmarked = ind.hasClass("fa-star");
            var new_bookmarked = !prev_bookmarked;

            if (new_bookmarked)
            {
              ind.removeClass("fa-star-o");
              ind.addClass("fa-star");
              btn_bookmark.addClass("relate-bookmarked");
            }
            else
            {
              ind.removeClass("fa-star");
              ind.addClass("fa-star-o");
              btn_bookmark.removeClass("relate-bookmarked");
            }

            var jqxhr = $.ajax(
                "{% url "relate-update_page_bookmark_state" course.identifier flow_session.id page_data.ordinal %}",
                {
                  type: "POST",
                  data: {
                    bookmark_state: new_bookmarked ? "1": "0"
                  },
                  beforeSend: function(xhr, settings) {
                    var csrftoken = get_cookie('csrftoken');
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                  }
                })
              .fail(function() {
                alert("Error while bookmarking page.")
              });
          });
    }
    $(document).ready(activate_bookmark_button);
  </script>

  {# }}} #}

  {# {{{ codemirror resizing, save #}

  <script type="text/javascript">
    $("div.CodeMirror")
    .resizable({
          resize: function (event, ui)
          {
            $("div.CodeMirror").each(
              function ()
              {
                var cm = this.CodeMirror;
                cm.refresh();
              });
          }
      })
    .each(
        function ()
        {
          function submit_page_for_feedback()
          {
            $(".relate-submit-button").click();
          }

          var cm = this.CodeMirror;
          cm.save = submit_page_for_feedback;
        });
  </script>

  {# }}} #}

{% endblock %}

{# vim: set foldmethod=marker: #}
